<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Midterm Quest: Full-Fit Edition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- CSS Variables & Reset --- */
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e2e;
            --primary: #8b5cf6; /* Violet */
            --secondary: #ec4899; /* Pink (kept constant for streak) */
            --accent: #3b82f6; /* Blue */
            --gold: #f59e0b;   /* Gold/Token (kept constant) */
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --success: #10b981;
            --danger: #ef4444;
            --orb-color: #8b5cf6;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: background-color 0.5s ease; 
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: var(--card-bg); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* --- Header / Stats Bar --- */
        header {
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(30, 30, 46, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 10;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .menu-toggle-btn {
            background: transparent;
            border: none;
            color: var(--text-main);
            font-size: 1.2rem;
            cursor: pointer;
            transition: color 0.3s;
        }
        .menu-toggle-btn:hover { color: var(--primary); }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 1px;
            transition: background 0.5s ease;
        }

        .stats-container {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .stat-badge {
            background: rgba(255, 255, 255, 0.05);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
            cursor: default;
        }

        /* NEW: Clickable Badge Style */
        .stat-badge.clickable {
            cursor: pointer;
        }
        .stat-badge.clickable:hover {
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.3);
        }

        .stat-badge.offline-mode {
            border-color: #444;
            background: rgba(100, 100, 100, 0.05);
            color: #777;
        }
        
        .stat-badge.offline-mode i {
            color: #777 !important;
            animation: none !important;
        }
        
        .stat-badge.offline-mode .streak-text {
            color: #777 !important;
            font-weight: normal;
        }
        
        .xp-progress-bg {
            position: absolute;
            left: 0; bottom: 0; height: 3px;
            background: var(--success);
            width: 0%; 
            transition: width 0.5s ease;
        }

        .stat-badge:hover { transform: translateY(-2px); background: rgba(255,255,255,0.1); }
        .stat-badge i { color: var(--accent); transition: color 0.5s ease; }
        .xp-text { color: var(--success); font-weight: bold; }
        .streak-text { color: var(--secondary); font-weight: bold; }
        .token-text { color: var(--gold); font-weight: bold; }
        .lvl-text { color: var(--text-main); font-weight: bold; }

        /* --- Calendar Switch Styling --- */
        .calendar-switch-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            position: relative;
        }

        .calendar-switch {
            width: 140px;
            height: 40px;
            background: var(--card-bg);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 2px;
            position: relative;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .calendar-slider-handle {
            position: absolute;
            width: 50%;
            height: 100%;
            border-radius: 20px;
            top: 0;
            left: 0;
            transition: transform 0.3s ease, background 0.3s ease;
            z-index: 2;
        }

        .calendar-switch[data-calendar="gregorian"] .calendar-slider-handle {
            transform: translateX(0);
            background: linear-gradient(90deg, var(--accent), var(--secondary)); 
        }

        .calendar-switch[data-calendar="jalali"] .calendar-slider-handle {
            transform: translateX(100%);
            background: linear-gradient(90deg, var(--success), var(--danger));
        }

        .calendar-icon {
            width: 50%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--text-muted);
            transition: color 0.3s ease;
            z-index: 3; 
            pointer-events: none; 
            line-height: 1;
        }
        .calendar-icon i { font-size: 1.1rem; margin-bottom: 2px; }

        .calendar-switch[data-calendar="gregorian"] .left-icon { color: white; }
        .calendar-switch[data-calendar="jalali"] .right-icon { color: white; }

        .icon-label { font-size: 0.65rem; }

        /* --- Main Grid Layout --- */
        main {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 1.5rem;
            padding: 1.5rem;
            overflow: hidden;
            position: relative;
        }

        /* --- Left Column: Planner --- */
        .planner-section {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: background-color 0.5s ease;
        }
        
        .planner-section[data-calendar-type="jalali"] #current-month {
            direction: rtl;
            font-family: Tahoma, 'Segoe UI', sans-serif; 
        }
        
        .week-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .nav-center {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .current-week-btn {
            background: var(--accent);
            color: white;
            border: none;
            width: 30px; 
            height: 30px;
            padding: 0; 
            border-radius: 50%; 
            display: flex; 
            align-items: center;
            justify-content: center;
            font-size: 1rem; 
            font-weight: bold;
            cursor: pointer;
            transition: background 0.5s ease;
        }
        .current-week-btn:hover { background: #3373d4; }

        .nav-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.2rem;
            transition: color 0.2s;
        }
        .nav-btn:hover { color: var(--text-main); }


        .btn-jiggle { animation: jiggle 0.4s 3; }
        @keyframes jiggle {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .days-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 1rem;
        }
        
        .days-row[data-calendar-type="jalali"] .day-name {
            font-size: 0.9rem;
            font-family: Tahoma, 'Segoe UI', sans-serif;
        }
        .days-row[data-calendar-type="jalali"] .day-num {
            font-family: Tahoma, 'Segoe UI', sans-serif;
            direction: rtl; 
        }

        .day-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            width: 13%;
            transition: all 0.2s;
        }

        .day-card:hover { background: rgba(255,255,255,0.05); }
        .day-card.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
            transition: background 0.5s ease, box-shadow 0.5s ease;
        }
        .day-name { font-size: 0.8rem; text-transform: uppercase; margin-bottom: 4px; }
        .day-num { font-size: 1.1rem; font-weight: bold; }

        .task-list {
            flex: 1;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .empty-state {
            text-align: center;
            color: var(--text-muted);
            margin-top: 2rem;
            font-style: italic;
        }

        .task-item {
            background: rgba(255,255,255,0.03);
            margin-bottom: 0.8rem;
            padding: 1rem;
            border-radius: 12px;
            display: flex;
            align-items: center; 
            gap: 1rem; 
            border-left: 4px solid var(--text-muted);
            transition: transform 0.2s, border-left-color 0.5s ease;
        }

        .task-item:hover { transform: translateX(4px); }
        .task-item.diff-easy { border-color: var(--success); }
        .task-item.diff-medium { border-color: var(--accent); }
        .task-item.diff-hard { border-color: var(--danger); }

        .task-info { flex: 1; min-width: 0; }
        .task-info h4 { 
            font-size: 1rem; 
            margin-bottom: 0.2rem;
            overflow: hidden;
            text-overflow: ellipsis; 
        }
        .task-info span { font-size: 0.8rem; color: var(--text-muted); }

        .task-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0; 
        }

        .check-btn {
            background: transparent;
            border: 2px solid var(--text-muted);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .check-btn:hover { border-color: var(--success); color: var(--success); }
        .check-btn.completed { background: var(--success); border-color: var(--success); color: white; }

        .del-btn {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 1rem;
            padding: 5px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .del-btn:hover { opacity: 1; }

        .add-task-form {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .add-input {
            flex: 1;
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 0.6rem;
            color: white;
        }

        .add-select {
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            border-radius: 8px;
            padding: 0 0.5rem;
        }

        .add-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0 1rem;
            cursor: pointer;
            transition: background 0.5s ease;
        }
        .add-btn:hover { background: #7c3aed; }

        /* --- Right Column: Focus & Timer --- */
        .focus-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .timer-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            transition: background-color 0.5s ease;
        }

        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .mode-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-muted);
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: var(--orb-color);
            border-color: var(--orb-color);
            color: white;
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.3);
        }

        .orb-container {
            width: 140px;
            height: 140px;
            margin: 0 auto 1.5rem;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .orb-container:active { transform: scale(0.95); }

        .orb {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            transition: background 0.5s ease, box-shadow 0.5s ease;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.8), var(--orb-color));
            box-shadow: 0 0 30px var(--orb-color), inset 0 0 20px rgba(255,255,255,0.5);
            animation: breathe 4s infinite ease-in-out;
            position: relative;
            z-index: 2;
        }

        .orb::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 110%; height: 110%;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.1);
            animation: spin 10s linear infinite;
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); box-shadow: 0 0 25px var(--orb-color); }
            50% { transform: scale(1.05); box-shadow: 0 0 40px var(--orb-color); }
        }
        @keyframes spin { 100% { transform: translate(-50%, -50%) rotate(360deg); } }

        .timer-display {
            font-size: 3rem;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
            margin-bottom: 1rem;
            text-shadow: 0 0 10px rgba(255,255,255,0.1);
        }

        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1.5rem; 
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            color: white;
            transition: background 0.2s;
        }
        .control-btn:hover { background: rgba(255,255,255,0.2); }
        .control-btn.primary { 
            background: var(--primary); 
            box-shadow: 0 4px 10px rgba(139, 92, 246, 0.3); 
            transition: background 0.5s ease, box-shadow 0.5s ease;
        }
        .control-btn.primary:hover { background: #7c3aed; }

        .ambient-controls {
            display: flex; 
            align-items: center;
            justify-content: center;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255,255,255,0.1);
            gap: 10px;
        }

        #ambient-status {
            font-size: 0.9rem;
            color: var(--text-muted);
        }


        /* --- Volume Panel --- */
        .volume-panel {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 0 1.5rem; 
            box-shadow: var(--shadow);
            max-height: 0; 
            padding-top: 0;
            padding-bottom: 0;
            margin-top: -1.5rem; 
            opacity: 0;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
            z-index: 5;
        }

        .volume-panel h4 {
            margin-bottom: 0.5rem;
            color: var(--primary);
            transition: opacity 0.2s;
        }

        .volume-slider-group {
            display: grid;
            grid-template-columns: 100px 1fr;
            gap: 0.5rem;
            align-items: center;
            transition: opacity 0.2s;
        }

        .volume-slider-group label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .focus-section.panel-open .volume-panel {
            max-height: 300px;
            padding-top: 1.5rem;
            padding-bottom: 1.5rem;
            margin-top: 0rem;
            opacity: 1;
        }

        /* Spotify Card */
        .spotify-card {
            background: #191414;
            border-radius: 16px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.05);
            transition: box-shadow 0.3s;
            height: 220px;
            transition: background-color 0.5s ease;
        }

        .spotify-card::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 16px;
            padding: 2px;
            background: linear-gradient(45deg, #1DB954, transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
            opacity: 0.5;
        }

        .spotify-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .spotify-logo { color: #1DB954; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem; }
        .playlist-toggle { background: transparent; border: none; color: white; cursor: pointer; }

        .spotify-embed-container {
            flex: 1; 
            border-radius: 8px;
            overflow: hidden;
            background: #000;
            position: relative;
            min-height: 152px;
        }

        iframe { width: 100%; height: 100%; border: none; }

        /* Sidebar (Playlists) */
        .sidebar {
            position: absolute;
            top: 0; right: 0; bottom: 0;
            width: 300px;
            background: var(--card-bg);
            z-index: 100;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.5s ease;
            border-left: 1px solid rgba(255,255,255,0.1);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            box-shadow: -5px 0 15px rgba(0,0,0,0.3);
        }

        .sidebar.open { transform: translateX(0); }

        /* Upcoming Quests Sidebar */
        .sidebar.left {
            right: auto;
            left: 0;
            transform: translateX(-100%);
            border-left: none;
            border-right: 1px solid rgba(255,255,255,0.1);
            box-shadow: 5px 0 15px rgba(0,0,0,0.3);
        }
        
        .sidebar.left.open { transform: translateX(0); }

        .upcoming-item {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.8rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            border-left: 4px solid var(--primary);
        }

        .upcoming-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .upcoming-title { font-weight: bold; font-size: 0.95rem; }
        .upcoming-timer { font-size: 0.8rem; font-weight: bold; color: var(--text-muted); }
        .upcoming-timer.today { color: var(--danger); }
        .upcoming-timer.tomorrow { color: var(--gold); } 

        .upcoming-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: flex-end;
        }

        .sidebar-btn {
            background: transparent;
            border: 1px solid var(--text-muted);
            color: var(--text-muted);
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .sidebar-btn:hover { color: white; border-color: white; }
        .sidebar-btn.finish:hover { border-color: var(--success); color: var(--success); background: rgba(16, 185, 129, 0.1); }
        .sidebar-btn.remove:hover { border-color: var(--danger); color: var(--danger); background: rgba(239, 68, 68, 0.1); }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .playlist-list {
            list-style: none;
            flex: 1;
            overflow-y: auto;
        }

        .playlist-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .playlist-item:hover { background: rgba(255,255,255,0.08); }
        .playlist-item.active { border: 1px solid #1DB954; }

        .playlist-name-input {
            background: transparent;
            border: none;
            color: white;
            font-family: inherit;
            width: 140px;
        }
        .playlist-name-input:focus { outline: 1px solid var(--accent); background: rgba(0,0,0,0.2); }

        .playlist-controls { display: flex; gap: 0.5rem; }
        .icon-btn { 
            background: transparent; border: none; color: var(--text-muted); 
            cursor: pointer; font-size: 0.9rem;
        }
        .icon-btn:hover { color: white; }
        .icon-btn.play-pl { color: #1DB954; }

        .add-playlist-btn {
            margin-top: 1rem;
            width: 100%;
            padding: 0.8rem;
            background: rgba(255,255,255,0.05);
            border: 1px dashed rgba(255,255,255,0.2);
            color: var(--text-muted);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .add-playlist-btn:hover { background: rgba(255,255,255,0.1); color: white; border-color: white; }

        /* Modal / Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(30, 30, 46, 0.95);
            padding: 1rem 2rem;
            border-radius: 30px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            border: 1px solid var(--primary);
            color: white;
            z-index: 1000;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-align: center;
            max-width: 80%;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast-quote { font-style: italic; display: block; margin-bottom: 0.5rem; }
        .toast-author { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

        /* Streak Recovery Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .modal-overlay.open { opacity: 1; pointer-events: all; }

        .modal-card {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            border: 1px solid var(--danger);
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s, background-color 0.5s ease;
        }
        .modal-overlay.open .modal-card { transform: scale(1); }

        .modal-icon { font-size: 3rem; color: var(--danger); margin-bottom: 1rem; }
        .modal-title { font-size: 1.5rem; margin-bottom: 0.5rem; color: white; }
        .modal-desc { color: var(--text-muted); margin-bottom: 1.5rem; }

        .modal-actions { display: flex; gap: 1rem; justify-content: center; }
        .modal-btn {
            padding: 0.8rem 1.2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-recover { background: var(--gold); color: black; }
        .btn-recover:hover { background: #d97706; }
        .btn-reset { background: transparent; color: var(--text-muted); border: 1px solid rgba(255,255,255,0.2); }
        .btn-reset:hover { border-color: white; color: white; }
        
        /* Tab Lock Overlay */
        #tab-lock-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(18, 18, 18, 0.8);
            backdrop-filter: blur(15px);
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
        }
        
        #tab-lock-overlay.active { display: flex; }

        .lock-text-main { font-size: 1.5rem; color: #94a3b8; margin-bottom: 1rem; font-weight: bold; }
        .lock-text-sub { font-size: 0.9rem; color: #64748b; }

        /* --- NEW: Milestone Modal & Bubble Effect Styles --- */
        #milestone-modal .modal-card {
            width: 95%;
            max-width: 800px;
            border: 1px solid var(--primary);
            box-shadow: 0 0 40px rgba(139, 92, 246, 0.2);
            padding: 2rem 1rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .milestone-title {
            text-align: center;
            font-size: 1.8rem;
            margin-bottom: 2rem;
            color: var(--primary);
            font-weight: bold;
            text-shadow: 0 0 10px rgba(139, 92, 246, 0.4);
        }

        .milestone-slider-container {
            width: 100%;
            height: 350px;
            position: relative;
            display: flex;
            align-items: center;
        }

        /* The Scrollable Track */
        .milestone-track {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            gap: 50px; /* Space between items */
            padding: 50px 50%; /* Padding triggers center alignment */
            height: 100%;
            align-items: center;
            scrollbar-width: none; /* Firefox hide scrollbar */
        }
        .milestone-track::-webkit-scrollbar { display: none; } /* Chrome hide scrollbar */

        .milestone-card {
            min-width: 220px;
            height: 280px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            scroll-snap-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255, 255, 255, 0.1);
            position: relative;
            
            /* Animation Props */
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), 
                        opacity 0.4s ease, 
                        border-color 0.4s ease,
                        box-shadow 0.4s ease;
            opacity: 0.4;
            transform: scale(0.8);
            filter: blur(1px);
        }

        /* The Bubble Effect: Active Item */
        .milestone-card.active {
            opacity: 1;
            transform: scale(1.15); /* Make it POP */
            border-color: var(--gold);
            box-shadow: 0 0 30px rgba(245, 158, 11, 0.4); /* Glow */
            filter: blur(0);
            z-index: 10;
            background: rgba(30, 30, 46, 0.95);
        }
        
        /* Completed style for passed levels */
        .milestone-card.completed {
            border-color: var(--success);
        }
        .milestone-card.completed.active {
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.4);
        }
        
        .ms-lvl-badge {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--text-muted);
            transition: color 0.3s;
        }
        .milestone-card.active .ms-lvl-badge { color: var(--gold); }
        .milestone-card.completed .ms-lvl-badge { color: var(--success); }

        .ms-lvl-text {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .ms-reward {
            font-size: 0.9rem;
            color: var(--text-muted);
            background: rgba(0,0,0,0.3);
            padding: 5px 10px;
            border-radius: 10px;
            margin-top: 10px;
        }

        .ms-status {
            position: absolute;
            top: 10px; right: 10px;
            font-size: 0.8rem;
            text-transform: uppercase;
            font-weight: bold;
            color: var(--text-muted);
        }
        .milestone-card.completed .ms-status { color: var(--success); }
        .milestone-card.active .ms-status { display: block; }

        .close-ms-btn {
            align-self: center;
            margin-top: 1rem;
            background: transparent;
            border: 1px solid var(--text-muted);
            color: var(--text-muted);
            padding: 0.5rem 2rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .close-ms-btn:hover { border-color: white; color: white; }


        @media (max-width: 900px) {
            main { grid-template-columns: 1fr; overflow-y: auto; }
            .sidebar { width: 80%; max-width: 300px; }
        }
    </style>
</head>
<body>

    <div id="tab-lock-overlay">
        <div class="lock-text-main">You can only have one tab open</div>
        <div class="lock-text-sub">Close the other tab to meet us again!</div>
    </div>

    <header>
        <div class="header-left">
            <button class="menu-toggle-btn" id="open-upcoming-sidebar"><i class="fa-solid fa-bars"></i></button>
            <div class="logo"><i class="fa-solid fa-scroll"></i> Midterm Quest</div>
        </div>
        
        <div class="calendar-switch-container">
            <div class="calendar-switch" id="calendar-switch" data-calendar="gregorian">
                <div class="calendar-slider-handle" id="calendar-handle"></div>
                <div class="calendar-icon left-icon" data-type="gregorian" title="Gregorian Calendar (USA)">
                    <i class="fa-solid fa-earth-americas"></i>
                    <span class="icon-label">USA</span>
                </div>
                <div class="calendar-icon right-icon" data-type="jalali" title="Jalali Calendar (Iran)">
                    <i class="fa-solid fa-globe-asia"></i>
                    <span class="icon-label" style="direction: rtl;">ایران</span>
                </div>
            </div>
        </div>

        <div class="stats-container">
            <div class="stat-badge clickable" id="level-badge" title="Click to view Milestones">
                <i class="fa-solid fa-crown" style="color: gold;"></i>
                <span id="lvl-display" class="lvl-text">Lvl 1</span>
            </div>
            <div class="stat-badge" title="Streak Tokens">
                <i class="fa-solid fa-shield-halved" style="color: var(--gold);"></i>
                <span id="token-display" class="token-text">3</span>
            </div>
            <div class="stat-badge" title="Experience Points">
                <div class="xp-progress-bg" id="xp-bar"></div>
                <i class="fa-solid fa-bolt"></i>
                <span id="xp-display" class="xp-text">0 / 100 XP</span>
            </div>
            <div class="stat-badge" id="streak-badge" title="Daily Streak">
                <i class="fa-solid fa-fire"></i>
                <span id="streak-display" class="streak-text">0 Days</span>
            </div>
        </div>
    </header>

    <main>
        <section class="planner-section" id="planner-section">
            <div class="week-nav">
                <button class="nav-btn" id="prev-week"><i class="fa-solid fa-chevron-left"></i></button>
                <div class="nav-center">
                    <h3 id="current-month">December 2025</h3>
                    <button class="current-week-btn" id="go-to-current-week" style="display:none;" title="Go to Current Week">
                        <i class="fa-solid fa-arrow-rotate-right"></i>
                    </button>
                </div>
                <button class="nav-btn" id="next-week"><i class="fa-solid fa-chevron-right"></i></button>
            </div>

            <div class="days-row" id="week-days"></div>

            <div class="task-list" id="task-list">
                <div class="empty-state">Select a day to view quests</div>
            </div>

            <form class="add-task-form" id="add-task-form">
                <input type="text" class="add-input" id="task-name" placeholder="New Quest..." required>
                <select class="add-select" id="task-diff">
                    <option value="easy">Easy (10XP)</option>
                    <option value="medium">Medium (20XP)</option>
                    <option value="hard">Hard (50XP)</option>
                </select>
                <button type="submit" class="add-btn"><i class="fa-solid fa-plus"></i></button>
            </form>
        </section>

        <section class="focus-section">
            <div class="timer-card" id="timer-card">
                <div class="mode-selector">
                    <button class="mode-btn active" data-mode="default" data-color="#8b5cf6">Default</button>
                    <button class="mode-btn" data-mode="rainy" data-color="#3b82f6">Rainy</button>
                    <button class="mode-btn" data-mode="nature" data-color="#10b981">Nature</button>
                </div>

                <div class="orb-container" id="motivation-orb">
                    <div class="orb"></div>
                </div>

                <div class="timer-display" id="timer">25:00</div>

                <div class="timer-controls">
                    <button class="control-btn" id="reset-timer"><i class="fa-solid fa-rotate-right"></i></button>
                    <button class="control-btn primary" id="toggle-timer"><i class="fa-solid fa-play"></i></button>
                </div>

                <div class="ambient-controls">
                    <button class="control-btn" id="toggle-ambient-mute" title="Quick Mute / Hold for Volume">
                        <i class="fa-solid fa-volume-off"></i> 
                    </button>
                    <span id="ambient-status">Sound Off</span>
                </div>
            </div>

            <div class="volume-panel" id="volume-panel">
                <h4><i class="fa-solid fa-sliders"></i> Advanced Volume</h4>
                <div class="volume-slider-group">
                    <label for="rainy-volume">Rainy Sound</label>
                    <input type="range" id="rainy-volume" min="0" max="100" value="50">

                    <label for="nature-volume">Nature Sound</label>
                    <input type="range" id="nature-volume" min="0" max="100" value="50">

                    <label for="music-volume">Music (Spotify)</label>
                    <input type="range" id="music-volume" min="0" max="100" value="50">
                </div>
            </div>
            <div class="spotify-card" id="spotify-card">
                <div class="spotify-header">
                    <div class="spotify-logo"><i class="fa-brands fa-spotify"></i> Spotify</div>
                    <button class="playlist-toggle" id="toggle-sidebar" title="Playlists"><i class="fa-solid fa-list-ul"></i></button>
                </div>
                <div class="spotify-embed-container" id="spotify-embed"></div>
            </div>
        </section>
    </main>

    <div class="sidebar left" id="upcoming-sidebar">
        <div class="sidebar-header">
            <h3>Nearest Quests</h3>
            <button class="nav-btn" id="close-upcoming-sidebar"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <ul class="playlist-list" id="upcoming-list"></ul>
    </div>

    <div class="sidebar" id="playlist-sidebar">
        <div class="sidebar-header">
            <h3>Saved Playlists</h3>
            <button class="nav-btn" id="close-sidebar"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <ul class="playlist-list" id="playlist-list"></ul>
        <button class="add-playlist-btn" id="add-playlist-btn">+ Add Playlist URL</button>
    </div>

    <div class="modal-overlay" id="streak-modal">
        <div class="modal-card">
            <div class="modal-icon"><i class="fa-solid fa-heart-crack"></i></div>
            <h2 class="modal-title">Streak Broken!</h2>
            <p class="modal-desc">You missed a day. Would you like to use a <b>Streak Token</b> to restore your progress?</p>
            <div class="modal-actions">
                <button class="modal-btn btn-recover" onclick="recoverStreak()">
                    <i class="fa-solid fa-shield-halved"></i> Use Token (<span id="modal-token-count">0</span> left)
                </button>
                <button class="modal-btn btn-reset" onclick="resetStreak()">
                    Accept Fate
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="milestone-modal">
        <div class="modal-card">
            <div class="milestone-title">Journey Milestones</div>
            
            <div class="milestone-slider-container">
                <div class="milestone-track" id="milestone-track">
                    </div>
            </div>

            <button class="close-ms-btn" id="close-milestones">Close Journey</button>
        </div>
    </div>

    <div class="toast" id="quote-toast">
        <span class="toast-quote" id="toast-text">"Quote goes here"</span>
        <span class="toast-author" id="toast-author">- Author</span>
    </div>

    <audio id="rainy-ambient" loop src="Ambients/Rainy-Back.mp3"></audio>
    <audio id="nature-ambient" loop src="Ambients/Nature-Back.mp3"></audio>

    <script>
/**
 * Midterm Quest - Full-Fit Edition
 */

// --- CALENDAR CONVERSION LOGIC ---
function isGregorianLeap(year) {
    return ((year % 4 == 0) && (year % 100 != 0)) || (year % 400 == 0);
}

const toFarsiDigits = (num) => {
    return num.toString().replace(/\d/g, d => '۰۱۲۳۴۵۶۷۸۹'[d]);
};

function gregorianToJalali(gy, gm, gd) {
    var g_days_in_month = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
    var j_days_in_month = [31, 31, 31, 31, 31, 31, 30, 30, 30, 30, 30, 29];

    var gy2 = (gy - 1600);
    var gm2 = (gm - 1);
    var gd2 = (gd - 1);

    var g_day_no = 365 * gy2 + Math.floor(gy2 / 4) - Math.floor((gy2 - 1) / 100) + Math.floor((gy2 + 399) / 400);

    for (var i = 0; i < gm2; ++i) {
        g_day_no += g_days_in_month[i];
    }
    if (gm2 > 1 && (((gy % 4 == 0) && (gy % 100 != 0)) || (gy % 400 == 0))) {
        g_day_no++;
    }

    g_day_no += gd2;
    var j_day_no = g_day_no - 79;
    var j_np = Math.floor(j_day_no / 12053);
    j_day_no %= 12053;
    var jy = 979 + 33 * j_np + 4 * Math.floor(j_day_no / 1461);
    j_day_no %= 1461;

    if (j_day_no >= 366) {
        jy += Math.floor((j_day_no - 1) / 365);
        j_day_no = (j_day_no - 1) % 365;
    }

    var i;
    for (i = 0; i < 11 && j_day_no >= j_days_in_month[i]; ++i) {
        j_day_no -= j_days_in_month[i];
    }

    var jm = i + 1;
    var jd = j_day_no + 1;

    return [jy, jm, jd]; 
}

function toJalali(date) {
    const [jy, jm, jd] = gregorianToJalali(date.getFullYear(), date.getMonth() + 1, date.getDate());
    return { year: jy, month: jm, day: jd, dayOfWeek: date.getDay() }; 
}

const JALALI_MONTH_NAMES = ["فروردین", "اردیبهشت", "خرداد", "تیر", "مرداد", "شهریور", "مهر", "آبان", "آذر", "دی", "بهمن", "اسفند"];
const JALALI_DAY_NAMES = ['شنبه', 'یکشنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه', 'پنجشنبه', 'جمعه'];
const GREGORIAN_DAY_NAMES = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];


// --- 1. State Management ---
const defaultState = {
    xp: 0,
    level: 1,
    streak: 0,
    streakTokens: 3,
    lastLogin: null,
    tasks: [], 
    playlists: [
        { id: 'pl1', name: 'Lofi Beats', url: 'https://open.spotify.com/embed/playlist/0vvXsWCC9xrXsKd4FyS8kM' },
        { id: 'pl2', name: 'Deep Focus', url: 'https://open.spotify.com/embed/playlist/37i9dQZF1DWZeKCadgRdKQ' },
        { id: 'pl3', name: 'Ambient', url: 'https://open.spotify.com/embed/playlist/37i9dQZF1DX4wG1zZBw7hm' }
    ],
    activePlaylistId: 'pl1',
    calendarType: 'gregorian',
    volumes: {
        rainy: 50, 
        nature: 50, 
        music: 50 
    }
};

let appState = JSON.parse(localStorage.getItem('midtermQuestState')) || defaultState;

if (appState.streakTokens === undefined) appState.streakTokens = 3;
if (appState.level === undefined) appState.level = 1;
if (appState.volumes === undefined) {
    appState.volumes = defaultState.volumes;
}
if (appState.calendarType === undefined) {
    appState.calendarType = 'gregorian';
}

if (!appState.playlists || !Array.isArray(appState.playlists) || appState.playlists.length === 0) {
    appState.playlists = defaultState.playlists;
    appState.activePlaylistId = defaultState.activePlaylistId;
}


let currentFocusMode = 'default';
let timerInterval = null;
let timeLeft = 25 * 60;
let isTimerRunning = false;
let currentSelectedDate = new Date(); 
const todayDate = new Date();

let isAmbientMuted = true;


const themes = {
    default: {
        orbColor: '#8b5cf6', 
        primary: '#8b5cf6',
        accent: '#3b82f6', 
        bgColor: '#121212',
        cardBg: '#1e1e2e',
        soundFile: null 
    },
    rainy: {
        orbColor: '#3b82f6', 
        primary: '#3b82f6',
        accent: '#5eead4', 
        bgColor: '#1c1f2e', 
        cardBg: '#2a304e',
        soundFile: 'rainy-ambient' 
    },
    nature: {
        orbColor: '#10b981', 
        primary: '#10b981',
        accent: '#f59e0b', 
        bgColor: '#1a1f18', 
        cardBg: '#2c3626',
        soundFile: 'nature-ambient' 
    }
};

// --- 2. Utilities & Theming Logic ---
const saveState = () => {
    localStorage.setItem('midtermQuestState', JSON.stringify(appState));
    updateStatsUI();
};

const generateId = () => '_' + Math.random().toString(36).substr(2, 9);

const formatDateKey = (date) => {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
};

const getGlobalDateKey = async () => {
    const streakBadge = document.getElementById('streak-badge');
    const streakDisplay = document.getElementById('streak-display');

    try {
        const response = await fetch('https://timeapi.io/api/Time/current/zone?timeZone=UTC');
        
        if (!response.ok) throw new Error('API Error');

        const data = await response.json();
        
        streakBadge.classList.remove('offline-mode');
        if (streakDisplay.innerText === 'No Internet') {
            streakDisplay.innerText = `${appState.streak} Days`;
        }
        
        const y = data.year;
        const m = String(data.month).padStart(2, '0');
        const d = String(data.day).padStart(2, '0');
        return `${y}-${m}-${d}`;
    } catch (e) {
        console.warn("Global time fetch failed, falling back to local time.");
        streakBadge.classList.add('offline-mode');
        streakDisplay.innerText = "No Internet";
        return formatDateKey(new Date());
    }
};


const changeFocusMode = (mode) => {
    const theme = themes[mode] || themes.default;
    const root = document.documentElement;
    const ambientAudioElements = [document.getElementById('rainy-ambient'), document.getElementById('nature-ambient')];

    root.style.setProperty('--orb-color', theme.orbColor);
    root.style.setProperty('--primary', theme.primary);
    root.style.setProperty('--accent', theme.accent);
    root.style.setProperty('--bg-color', theme.bgColor);
    root.style.setProperty('--card-bg', theme.cardBg);

    const logo = document.querySelector('.logo');
    logo.style.background = `linear-gradient(to right, ${theme.primary}, var(--secondary))`;

    ambientAudioElements.forEach(audio => {
        if (audio) { audio.pause(); audio.currentTime = 0; }
    });

    currentFocusMode = mode;

    if (theme.soundFile && !isAmbientMuted) {
        const ambientAudio = document.getElementById(theme.soundFile);
        if (ambientAudio) {
            const volumePercent = theme.soundFile === 'rainy-ambient' ? appState.volumes.rainy : appState.volumes.nature;
            ambientAudio.volume = volumePercent / 100; 
            ambientAudio.play().catch(e => console.log("Ambient Audio Playback blocked by browser:", e));
        }
    }
    updateAmbientButtonUI();
};


// --- Advanced Volume Panel Elements & Logic ---
const muteButton = document.getElementById('toggle-ambient-mute');
const ambientStatusText = document.getElementById('ambient-status');
const focusSection = document.querySelector('.focus-section');
const rainySlider = document.getElementById('rainy-volume');
const natureSlider = document.getElementById('nature-volume');
const musicSlider = document.getElementById('music-volume');

const updateAmbientButtonUI = () => {
    const icon = muteButton.querySelector('i');
    const theme = themes[currentFocusMode] || themes.default;

    if (isAmbientMuted || !theme.soundFile) {
        icon.className = 'fa-solid fa-volume-off';
        ambientStatusText.textContent = 'Sound Off';
        muteButton.style.color = 'var(--text-muted)';
    } else {
        icon.className = 'fa-solid fa-volume-high';
        ambientStatusText.textContent = 'Sound On';
        muteButton.style.color = 'var(--primary)';
    }
};

const toggleAmbientMute = () => {
    if (currentFocusMode === 'default') {
        showToast("Select 'Rainy' or 'Nature' mode to enable ambient sound.", "System");
        return; 
    }

    isAmbientMuted = !isAmbientMuted;
    const theme = themes[currentFocusMode];
    const ambientAudio = document.getElementById(theme.soundFile);

    if (ambientAudio) {
        if (!isAmbientMuted) {
            const volumePercent = theme.soundFile === 'rainy-ambient' ? appState.volumes.rainy : appState.volumes.nature;
            ambientAudio.volume = volumePercent / 100; 
            ambientAudio.play().catch(e => console.log("Ambient Audio Playback blocked by browser:", e));
        } else {
            ambientAudio.pause();
        }
    }

    updateAmbientButtonUI();
};

const updateAmbientAudioVolumes = () => {
    const rainyAudio = document.getElementById('rainy-ambient');
    const natureAudio = document.getElementById('nature-ambient');

    if (rainyAudio) rainyAudio.volume = appState.volumes.rainy / 100;
    if (natureAudio) natureAudio.volume = appState.volumes.nature / 100;

    if (!isAmbientMuted) {
         const theme = themes[currentFocusMode];
         const activeAudio = document.getElementById(theme.soundFile);
         if (activeAudio && activeAudio.paused) activeAudio.play().catch(e => {});
    }
};

const syncSlidersToState = () => {
    rainySlider.value = appState.volumes.rainy;
    natureSlider.value = appState.volumes.nature;
    musicSlider.value = appState.volumes.music;
};

const toggleVolumePanel = (open) => {
    if (open) {
        focusSection.classList.add('panel-open');
        syncSlidersToState(); 
    } else {
        focusSection.classList.remove('panel-open');
    }
};

let pressTimer = null;
const PRESS_DURATION = 500; 

muteButton.addEventListener('mousedown', (e) => {
    clearTimeout(pressTimer); 

    pressTimer = setTimeout(() => {
        toggleVolumePanel(true);
        pressTimer = null; 
    }, PRESS_DURATION);
});

muteButton.addEventListener('mouseup', () => {
    if (pressTimer !== null) {
        clearTimeout(pressTimer);
        if (focusSection.classList.contains('panel-open')) {
            toggleVolumePanel(false); 
        } else {
            toggleAmbientMute(); 
        }
    }
    pressTimer = null; 
});

muteButton.addEventListener('mouseleave', () => {
    clearTimeout(pressTimer);
    pressTimer = null;
});

rainySlider.addEventListener('input', (e) => {
    appState.volumes.rainy = parseInt(e.target.value, 10);
    updateAmbientAudioVolumes();
    saveState();
});
natureSlider.addEventListener('input', (e) => {
    appState.volumes.nature = parseInt(e.target.value, 10);
    updateAmbientAudioVolumes();
    saveState();
});
musicSlider.addEventListener('input', (e) => {
    appState.volumes.music = parseInt(e.target.value, 10);
    saveState();
});


const getXpForLevel = (lvl) => {
    return Math.floor(100 * Math.pow(1.02, lvl - 1));
};

const calculateLevelData = (totalXP) => {
    let currentLvl = 1;
    let xpRemaining = totalXP;
    let reqXP = getXpForLevel(currentLvl);

    while (xpRemaining >= reqXP) {
        xpRemaining -= reqXP;
        currentLvl++;
        reqXP = getXpForLevel(currentLvl);
    }

    return {
        level: currentLvl,
        currentXP: xpRemaining, 
        neededXP: reqXP         
    };
};

const updateStatsUI = () => {
    const lvlData = calculateLevelData(appState.xp);

    if (lvlData.level > appState.level) {
        for (let l = appState.level + 1; l <= lvlData.level; l++) {
            if (l % 5 === 0) {
                appState.streakTokens++;
                showToast("Bonus Reward!", "+1 Streak Token");
            }
        }
        appState.level = lvlData.level;
        showToast("Level Up!", `Welcome to Level ${appState.level}`);
        triggerOrbReaction('level-up');
    } else {
        appState.level = lvlData.level;
    }

    document.getElementById('xp-display').textContent = `${Math.floor(lvlData.currentXP)} / ${lvlData.neededXP} XP`;
    const streakBadge = document.getElementById('streak-badge');
    if (!streakBadge.classList.contains('offline-mode')) {
        document.getElementById('streak-display').textContent = `${appState.streak} Days`;
    }
    document.getElementById('token-display').textContent = `${appState.streakTokens}`;
    document.getElementById('lvl-display').textContent = `Lvl ${appState.level}`;
    document.getElementById('modal-token-count').textContent = `${appState.streakTokens}`;

    const percentage = Math.min(100, (lvlData.currentXP / lvlData.neededXP) * 100);
    document.getElementById('xp-bar').style.width = `${percentage}%`;
};

// --- STREAK LOGIC (Updated for Global Clock) ---
const checkStreak = async () => {
    const today = await getGlobalDateKey();
    
    if (!appState.lastLogin) {
        appState.lastLogin = today;
        appState.streak = 1; 
        saveState();
        return;
    }
    if (appState.lastLogin === today) return; 

    const lastDate = new Date(appState.lastLogin);
    const currDate = new Date(today);
    const diffTime = Math.abs(currDate - lastDate);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

    if (diffDays === 1) {
        appState.streak++;
        appState.lastLogin = today;
        triggerOrbReaction('level-up'); 
        showToast("Streak Increased!", "Keep it up!");
        saveState();
    } else if (diffDays > 1) {
        if (appState.streakTokens > 0) {
            document.getElementById('streak-modal').classList.add('open');
        } else {
            appState.streak = 1;
            appState.lastLogin = today;
            saveState();
            showToast("Streak Lost...", "No tokens left.");
        }
    }
};

window.recoverStreak = () => {
    if (appState.streakTokens > 0) {
        appState.streakTokens--;
        appState.lastLogin = formatDateKey(new Date()); 
        saveState();
        document.getElementById('streak-modal').classList.remove('open');
        showToast("Streak Saved!", "1 Token used");
    }
};

window.resetStreak = () => {
    appState.streak = 1;
    appState.lastLogin = formatDateKey(new Date());
    saveState();
    document.getElementById('streak-modal').classList.remove('open');
};


// --- 3. Modules ---

/* === Planner Module === */

const isCurrentWeek = (dateInWeek) => {
    const today = new Date();
    const startOfWeek = getStartOfWeek(dateInWeek); 
    
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6); 

    today.setHours(0, 0, 0, 0);
    startOfWeek.setHours(0, 0, 0, 0);
    endOfWeek.setHours(0, 0, 0, 0);

    return (today.getTime() >= startOfWeek.getTime() && today.getTime() <= endOfWeek.getTime());
};

const getStartOfWeek = (date) => {
    const d = new Date(date);
    d.setHours(0, 0, 0, 0);

    let startDayOffset; 
    let currentDay = d.getDay(); 

    if (appState.calendarType === 'gregorian') {
        startDayOffset = currentDay; 
    } else {
        startDayOffset = (currentDay + 1) % 7; 
    }

    d.setDate(d.getDate() - startDayOffset);
    return d;
};


const renderCalendar = () => {
    const weekContainer = document.getElementById('week-days');
    const plannerSection = document.getElementById('planner-section');
    const goToCurrentWeekBtn = document.getElementById('go-to-current-week');
    const currentMonthTitle = document.getElementById('current-month');
    weekContainer.innerHTML = '';
    
    document.getElementById('calendar-switch').setAttribute('data-calendar', appState.calendarType);
    plannerSection.setAttribute('data-calendar-type', appState.calendarType);
    weekContainer.setAttribute('data-calendar-type', appState.calendarType);


    const startOfWeek = getStartOfWeek(currentSelectedDate);
    const todayKey = formatDateKey(todayDate);

    if (isCurrentWeek(currentSelectedDate)) {
        goToCurrentWeekBtn.style.display = 'none';
    } else {
        goToCurrentWeekBtn.style.display = 'flex';
    }

    const monthNamesGregorian = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    
    for (let i = 0; i < 7; i++) {
        const loopDate = new Date(startOfWeek);
        loopDate.setDate(startOfWeek.getDate() + i);

        let dayName, dayNum;
        let dayIndex = loopDate.getDay(); 

        if (appState.calendarType === 'gregorian') {
            dayName = GREGORIAN_DAY_NAMES[dayIndex];
            dayNum = loopDate.getDate();
        } else {
            const jalaliDate = toJalali(loopDate);
            const jalaliDayIndex = (dayIndex + 1) % 7; 
            dayName = JALALI_DAY_NAMES[jalaliDayIndex];
            dayNum = toFarsiDigits(jalaliDate.day);
        }

        const dateKey = formatDateKey(loopDate);

        const dayEl = document.createElement('div');
        dayEl.className = `day-card ${dateKey === formatDateKey(currentSelectedDate) ? 'active' : ''} ${dateKey === todayKey ? 'today' : ''}`;

        dayEl.innerHTML = `
            <span class="day-name">${dayName}</span>
            <span class="day-num">${dayNum}</span>
        `;

        dayEl.addEventListener('click', () => {
            currentSelectedDate = loopDate; 
            renderCalendar();
            renderTasks();
        });

        weekContainer.appendChild(dayEl);
    }

    let displayDate;
    if (appState.calendarType === 'gregorian') {
        displayDate = `${monthNamesGregorian[startOfWeek.getMonth()]} ${startOfWeek.getFullYear()}`;
    } else {
        const jalaliDate = toJalali(startOfWeek);
        const farsiYear = toFarsiDigits(jalaliDate.year); 
        displayDate = `${JALALI_MONTH_NAMES[jalaliDate.month - 1]} ${farsiYear}`;
    }
    currentMonthTitle.innerText = displayDate;
};


const renderTasks = () => {
    const listContainer = document.getElementById('task-list');
    listContainer.innerHTML = '';

    const dateKey = formatDateKey(currentSelectedDate);
    const daysTasks = appState.tasks.filter(t => t.date === dateKey);

    if (daysTasks.length === 0) {
        listContainer.innerHTML = `<div class="empty-state">No quests for this day.</div>`;
        return;
    }

    daysTasks.forEach(task => {
        const item = document.createElement('div');
        item.className = `task-item diff-${task.diff}`;
        item.innerHTML = `
            <div class="task-info">
                <h4 style="text-decoration: ${task.completed ? 'line-through' : 'none'}">${task.title}</h4>
                <span>${task.diff.toUpperCase()}</span>
            </div>
            <div class="task-actions">
                <button class="check-btn ${task.completed ? 'completed' : ''}" onclick="toggleTask('${task.id}')">
                    <i class="fa-solid fa-check"></i>
                </button>
                <button class="del-btn" onclick="deleteTask('${task.id}')">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
        `;
        listContainer.appendChild(item);
    });
};

window.addTask = (e) => {
    e.preventDefault();
    const title = document.getElementById('task-name').value;
    const diff = document.getElementById('task-diff').value;

    if (!title) return;

    appState.tasks.push({
        id: generateId(),
        title,
        diff,
        date: formatDateKey(currentSelectedDate), 
        completed: false
    });

    document.getElementById('task-name').value = '';
    saveState();
    renderTasks();
    renderUpcomingQuests(); 
};

window.toggleTask = (id) => {
    const task = appState.tasks.find(t => t.id === id);
    if (task) {
        task.completed = !task.completed;
        const xpMap = { easy: 10, medium: 20, hard: 50 };

        if (task.completed) {
            appState.xp += xpMap[task.diff];
            triggerOrbReaction('success');
        } else {
            appState.xp = Math.max(0, appState.xp - xpMap[task.diff]);
        }
        saveState();
        renderTasks();
        renderUpcomingQuests(); 
    }
};

window.deleteTask = (id) => {
    appState.tasks = appState.tasks.filter(t => t.id !== id);
    saveState();
    renderTasks();
    renderUpcomingQuests(); 
};

document.getElementById('add-task-form').addEventListener('submit', window.addTask);
document.getElementById('prev-week').addEventListener('click', () => {
    currentSelectedDate.setDate(currentSelectedDate.getDate() - 7);
    renderCalendar(); renderTasks();
});
document.getElementById('next-week').addEventListener('click', () => {
    currentSelectedDate.setDate(currentSelectedDate.getDate() + 7);
    renderCalendar(); renderTasks();
});

document.getElementById('go-to-current-week').addEventListener('click', (e) => {
    const btn = e.currentTarget;
    btn.classList.add('btn-jiggle');

    currentSelectedDate = new Date();

    setTimeout(() => {
        renderCalendar(); 
        renderTasks();
        btn.classList.remove('btn-jiggle');
    }, 400); 
});


/* === Calendar Switch Logic === */
window.switchCalendar = () => {
    const newType = appState.calendarType === 'gregorian' ? 'jalali' : 'gregorian';
    appState.calendarType = newType;
    saveState();

    renderCalendar();
    renderTasks();
};

document.getElementById('calendar-switch').addEventListener('click', window.switchCalendar);


/* === Timer & Orb === */
const formatTime = (seconds) => {
    const m = Math.floor(seconds / 60).toString().padStart(2, '0');
    const s = (seconds % 60).toString().padStart(2, '0');
    return `${m}:${s}`;
};

const updateTimerDisplay = () => document.getElementById('timer').innerText = formatTime(timeLeft);

const toggleTimer = () => {
    const btnIcon = document.querySelector('#toggle-timer i');
    if (isTimerRunning) {
        clearInterval(timerInterval);
        isTimerRunning = false;
        btnIcon.className = 'fa-solid fa-play';
    } else {
        isTimerRunning = true;
        btnIcon.className = 'fa-solid fa-pause';
        timerInterval = setInterval(() => {
            if (timeLeft > 0) {
                timeLeft--;
                updateTimerDisplay();
            } else {
                clearInterval(timerInterval);
                isTimerRunning = false;
                btnIcon.className = 'fa-solid fa-play';
                appState.xp += 100; 
                saveState();
                showToast("Focus Session Complete! +100 XP", "System");
                triggerOrbReaction('level-up');
                timeLeft = 25 * 60; 
                updateTimerDisplay();
            }
        }, 1000);
    }
};

const resetTimer = () => {
    clearInterval(timerInterval);
    isTimerRunning = false;
    document.querySelector('#toggle-timer i').className = 'fa-solid fa-play';
    timeLeft = 25 * 60;
    updateTimerDisplay();
};

document.querySelectorAll('.mode-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');

        changeFocusMode(e.target.dataset.mode); 

    });
});

document.getElementById('toggle-timer').addEventListener('click', toggleTimer);
document.getElementById('reset-timer').addEventListener('click', resetTimer);

/* === Orb & Quotes === */
const quotes = {
    default: [
        {q: "Believe you can and you're halfway there.", a: "Theodore Roosevelt"},
        {q: "It always seems impossible until it's done.", a: "Nelson Mandela"},
        {q: "Start where you are. Use what you have.", a: "Arthur Ashe"},
        {q: "The secret of getting ahead is getting started.", a: "Mark Twain"},
        {q: "Don't watch the clock; do what it does. Keep going.", a: "Sam Levenson"},
        {q: "Quality is not an act, it is a habit.", a: "Aristotle"},
        {q: "There is no substitute for hard work.", a: "Thomas Edison"},
        {q: "What we think, we become.", a: "Buddha"},
        {q: "Problems are not stop signs, they are guidelines.", a: "Robert H. Schuller"},
        {q: "Aim for the moon. If you miss, you may hit a star.", a: "W. Clement Stone"},
        {q: "Everything you've ever wanted is on the other side of fear.", a: "George Addair"},
        {q: "Opportunities don't happen, you create them.", a: "Chris Grosser"},
        {q: "Success is walking from failure to failure with no loss of enthusiasm.", a: "Winston Churchill"},
        {q: "If you are going through hell, keep going.", a: "Winston Churchill"},
        {q: "What separates the talented from the successful is a lot of hard work.", a: "Stephen King"},
        {q: "Wisdom is not a product of schooling but of the lifelong attempt to acquire it.", a: "Albert Einstein"},
        {q: "You don't have to be great to start, but you have to start to be great.", a: "Zig Ziglar"},
        {q: "Education is the passport to the future.", a: "Malcolm X"},
        {q: "The expert in anything was once a beginner.", a: "Helen Hayes"},
        {q: "Motivation is what gets you started. Habit is what keeps you going.", a: "Jim Ryun"},
        {q: "There are no shortcuts to any place worth going.", a: "Beverly Sills"},
        {q: "Failure is the condiment that gives success its flavor.", a: "Truman Capote"},
        {q: "Don't let yesterday take up too much of today.", a: "Will Rogers"},
        {q: "You learn more from failure than from success.", a: "Unknown"},
        {q: "If you can dream it, you can do it.", a: "Walt Disney"},
        {q: "Do one thing every day that scares you.", a: "Eleanor Roosevelt"},
        {q: "Well done is better than well said.", a: "Benjamin Franklin"},
        {q: "The best way to predict the future is to create it.", a: "Peter Drucker"},
        {q: "Action is the foundational key to all success.", a: "Pablo Picasso"},
        {q: "Perseverance is failing 19 times and succeeding the 20th.", a: "Julie Andrews"}
    ],
    rainy: [
        {q: "Storms make trees take deeper roots.", a: "Dolly Parton"},
        {q: "Let the rain wash away the worry.", a: "Unknown"},
        {q: "Rain is just confetti from the sky.", a: "Unknown"},
        {q: "Some people feel the rain. Others just get wet.", a: "Bob Marley"},
        {q: "The best thing one can do when it's raining is to let it rain.", a: "Longfellow"},
        {q: "Life isn't about waiting for the storm to pass, it's about learning to dance in the rain.", a: "Vivian Greene"},
        {q: "Without rain, there is no life.", a: "Jerry Yang"},
        {q: "Into each life some rain must fall.", a: "Longfellow"},
        {q: "Look for the rainbow in every storm.", a: "Unknown"},
        {q: "Rainy days should be spent at home with a cup of tea and a good book.", a: "Bill Watterson"},
        {q: "Clouds come floating into my life, no longer to carry rain or usher storm, but to add color to my sunset sky.", a: "Tagore"},
        {q: "Tears of joy are like the summer rain drops pierced by sunbeams.", a: "Hosea Ballou"},
        {q: "A rainy day is the perfect time for a walk in the woods.", a: "Rachel Carson"},
        {q: "The sound of rain needs no translation.", a: "Alan Watts"},
        {q: "Do not be angry with the rain; it simply does not know how to fall upwards.", a: "Vladimir Nabokov"},
        {q: "Thy fate is the common fate of all; Into each life some rain must fall.", a: "Longfellow"},
        {q: "I like people who smile when it’s raining.", a: "Unknown"},
        {q: "Rain showers my spirit and waters my soul.", a: "Emily Logan"},
        {q: "Let the rain kiss you.", a: "Langston Hughes"},
        {q: "Focus on the sound of the rain, not the gray of the sky.", a: "Unknown"},
        {q: "The rain begins with a single drop.", a: "Manal al-Sharif"},
        {q: "Quiet minds cannot be perplexed or frightened but go on in fortune or misfortune at their own private pace, like a clock during a thunderstorm.", a: "Robert Louis Stevenson"},
        {q: "Every storm runs out of rain.", a: "Maya Angelou"},
        {q: "Rain hangs about the place, like a friendly ghost.", "a": "Barbara Acton-Bond"},
        {q: "The drop of rain maketh a hole in the stone, not by violence, but by oft falling.", a: "Latimer"},
        {q: "It always rains hardest on those who deserve the sun.", a: "Unknown"},
        {q: "The nicest thing about the rain is that it always stops.", a: "A.A. Milne"},
        {q: "When it rains, look for rainbows.", a: "Unknown"},
        {q: "Let the rain beat upon your head with silver liquid drops.", a: "Langston Hughes"},
        {q: "Embrace the grey days, they make the green ones greener.", a: "Unknown"}
    ],
    nature: [
        {q: "Adopt the pace of nature: her secret is patience.", a: "Ralph Waldo Emerson"},
        {q: "In every walk with nature one receives far more than he seeks.", a: "John Muir"},
        {q: "The earth has music for those who listen.", a: "Shakespeare"},
        {q: "Look deep into nature, and then you will understand everything better.", a: "Albert Einstein"},
        {q: "Nature does not hurry, yet everything is accomplished.", a: "Lao Tzu"},
        {q: "To sit in the shade on a fine day and look upon verdure is the most perfect refreshment.", a: "Jane Austen"},
        {q: "Colors are the smiles of nature.", a: "Leigh Hunt"},
        {q: "Study nature, love nature, stay close to nature. It will never fail you.", a: "Frank Lloyd Wright"},
        {q: "The poetry of the earth is never dead.", a: "John Keats"},
        {q: "Nature always wears the colors of the spirit.", a: "Ralph Waldo Emerson"},
        {q: "Just living is not enough... one must have sunshine, freedom, and a little flower.", a: "Hans Christian Andersen"},
        {q: "I go to nature to be soothed and healed.", a: "John Burroughs"},
        {q: "Wilderness is not a luxury but a necessity of the human spirit.", a: "Edward Abbey"},
        {q: "The clearest way into the Universe is through a forest wilderness.", a: "John Muir"},
        {q: "Leave the road, take the trails.", a: "Pythagoras"},
        {q: "Deep in their roots, all flowers keep the light.", a: "Theodore Roethke"},
        {q: "Everything in nature invites us constantly to be what we are.", a: "Gretel Ehrlich"},
        {q: "Nature is not a place to visit. It is home.", a: "Gary Snyder"},
        {q: "If you truly love nature, you will find beauty everywhere.", a: "Vincent Van Gogh"},
        {q: "Spring is nature's way of saying, 'Let's party!'", a: "Robin Williams"},
        {q: "The mountains are calling and I must go.", a: "John Muir"},
        {q: "In nature, nothing is perfect and everything is perfect.", a: "Alice Walker"},
        {q: "Time spent amongst trees is never time wasted.", a: "Katrina Mayer"},
        {q: "Green is the prime color of the world, and that from which its loveliness arises.", a: "Pedro Calderon"},
        {q: "Keep your face to the sunshine and you cannot see a shadow.", a: "Helen Keller"},
        {q: "Wherever you go, no matter what the weather, always bring your own sunshine.", a: "Anthony J. D'Angelo"},
        {q: "The best way to predict the future is to create it.", a: "Peter Drucker"},
        {q: "Action is the foundational key to all success.", a: "Pablo Picasso"},
        {q: "Perseverance is failing 19 times and succeeding the 20th.", a: "Julie Andrews"}
    ],
    hardcore: [
        {q: "Pain is temporary. Quitting lasts forever.", a: "Lance Armstrong"},
        {q: "Do it or don't. There is no try.", a: "Yoda"},
        {q: "Don't stop when you're tired. Stop when you're done.", a: "David Goggins"},
        {q: "I don't stop when I'm tired, I stop when I'm done.", a: "James Bond"},
        {q: "Discipline is doing what needs to be done, even if you don't want to.", a: "Unknown"},
        {q: "Your excuses are lies your fears have sold you.", a: "Robin Sharma"},
        {q: "Suffer the pain of discipline or suffer the pain of regret.", a: "Jim Rohn"},
        {q: "If you want something you've never had, you must be willing to do something you've never done.", a: "Thomas Jefferson"},
        {q: "The only easy day was yesterday.", a: "US Navy SEALs"},
        {q: "Get comfortable being uncomfortable.", a: "David Goggins"},
        {q: "Nobody cares. Work harder.", a: "Cameron Hanes"},
        {q: "Obsessed is just a word the lazy use to describe the dedicated.", a: "Russell Warren"},
        {q: "Success isn't owned. It's leased. And rent is due every day.", a: "J.J. Watt"},
        {q: "Be a warrior, not a worrier.", a: "Unknown"},
        {q: "Don't decrease the goal. Increase the effort.", a: "Unknown"},
        {q: "If it doesn't challenge you, it won't change you.", a: "Fred DeVito"},
        {q: "You can have results or excuses. Not both.", a: "Unknown"},
        {q: "The body achieves what the mind believes.", a: "Unknown"},
        {q: "Push yourself, because no one else is going to do it for you.", a: "Unknown"},
        {q: "It's going to be hard, but hard does not mean impossible.", a: "Unknown"},
        {q: "Wake up with determination. Go to bed with satisfaction.", a: "Unknown"},
        {q: "Do something today that your future self will thank you for.", a: "Unknown"},
        {q: "Little by little, a little becomes a lot.", a: "Tanzanian Proverb"},
        {q: "Don't wish it were easier. Wish you were better.", a: "Jim Rohn"},
        {q: "The difference between who you are and who you want to be is what you do.", a: "Unknown"},
        {q: "Go the extra mile. It's never crowded there.", a: "Dr. Wayne Dyer"},
        {q: "Stay hungry. Stay foolish.", a: "Steve Jobs"},
        {q: "Dream big and dare to fail.", a: "Norman Vaughan"},
        {q: "It is not the mountain we conquer, but ourselves.", a: "Sir Edmund Hillary"},
        {q: "Be the hardest working person in the room.", a: "Dwayne Johnson"}
    ]
};

const showToast = (text, author) => {
    const toast = document.getElementById('quote-toast');
    document.getElementById('toast-text').innerText = text;
    document.getElementById('toast-author').innerText = author;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 4000);
};

const triggerOrbReaction = (type) => {
    const orbEl = document.querySelector('.orb');
    if (type === 'level-up') {
        orbEl.style.transform = 'scale(1.5)';
        setTimeout(() => orbEl.style.transform = 'scale(1)', 300);
    } else if (type === 'success') {
        const oldColor = getComputedStyle(document.documentElement).getPropertyValue('--orb-color');
        document.documentElement.style.setProperty('--orb-color', '#10b981');
        setTimeout(() => document.documentElement.style.setProperty('--orb-color', oldColor), 500);
    } else if (type === 'hardcore') {
        orbEl.style.filter = 'hue-rotate(90deg) brightness(1.5)';
        setTimeout(() => orbEl.style.filter = 'none', 1000);
    }

    if(type === 'click') {
        const list = quotes[currentFocusMode] || quotes.default;
        const random = list[Math.floor(Math.random() * list.length)];
        showToast(`"${random.q}"`, `- ${random.a}`);
    }
};

let orbPressTimer;
const orb = document.getElementById('motivation-orb');

orb.addEventListener('mousedown', () => {
    orbPressTimer = setTimeout(() => {
        const list = quotes.hardcore;
        const random = list[Math.floor(Math.random() * list.length)];
        showToast(`"${random.q}"`, `- ${random.a}`);
        triggerOrbReaction('hardcore');
    }, 800);
});

orb.addEventListener('mouseup', () => clearTimeout(orbPressTimer));
orb.addEventListener('mouseleave', () => clearTimeout(orbPressTimer));
orb.addEventListener('click', (e) => {
    if(e.detail === 1) triggerOrbReaction('click');
});

/* === Spotify & Playlist Management === */
const renderSpotifyEmbed = (url) => {
    const container = document.getElementById('spotify-embed');
    let embedUrl = url; 
    if(url.includes('open.spotify.com/playlist') && !url.includes('/embed/')) {
        embedUrl = url.replace('/playlist/', '/embed/playlist/');
    }
    container.innerHTML = `<iframe src="${embedUrl}" width="100%" height="100%" frameBorder="0" allow="encrypted-media"></iframe>`;
};

const renderPlaylistSidebar = () => {
    const list = document.getElementById('playlist-list');
    list.innerHTML = '';

    appState.playlists.forEach((pl) => {
        const li = document.createElement('li');
        li.className = `playlist-item ${appState.activePlaylistId === pl.id ? 'active' : ''}`;
        li.innerHTML = `
            <input type="text" class="playlist-name-input" value="${pl.name}" onchange="updatePlaylistName('${pl.id}', this.value)">
            <div class="playlist-controls">
                <button class="icon-btn play-pl" onclick="playPlaylist('${pl.id}')"><i class="fa-solid fa-play"></i></button>
                <button class="icon-btn" onclick="removePlaylist('${pl.id}')"><i class="fa-solid fa-trash"></i></button>
            </div>
        `;
        list.appendChild(li);
    });
};

window.playPlaylist = (id) => {
    const pl = appState.playlists.find(p => p.id === id);
    if(pl) {
        appState.activePlaylistId = id;
        renderSpotifyEmbed(pl.url);
        renderPlaylistSidebar();
        saveState();
    }
};

window.updatePlaylistName = (id, newName) => {
    const pl = appState.playlists.find(p => p.id === id);
    if(pl) pl.name = newName;
    saveState();
};

window.removePlaylist = (id) => {
    if (appState.playlists.length <= 1) {
        alert("Must have at least one playlist.");
        return;
    }
    appState.playlists = appState.playlists.filter(p => p.id !== id);
    if (appState.activePlaylistId === id) window.playPlaylist(appState.playlists[0].id);
    saveState();
    renderPlaylistSidebar();
};

document.getElementById('add-playlist-btn').addEventListener('click', () => {
    const url = prompt("Enter Spotify Playlist URL:");
    if (url) {
        appState.playlists.push({ id: generateId(), name: 'New Playlist', url: url });
        saveState();
        renderPlaylistSidebar();
    }
});

const sidebar = document.getElementById('playlist-sidebar');
document.getElementById('toggle-sidebar').addEventListener('click', () => sidebar.classList.add('open'));
document.getElementById('close-sidebar').addEventListener('click', () => sidebar.classList.remove('open'));

const upcomingSidebar = document.getElementById('upcoming-sidebar');

const renderUpcomingQuests = () => {
    const list = document.getElementById('upcoming-list');
    list.innerHTML = '';

    const today = new Date();
    today.setHours(0,0,0,0);

    const upcoming = appState.tasks
        .filter(t => !t.completed)
        .map(t => {
            const parts = t.date.split('-');
            const objDate = new Date(parts[0], parts[1]-1, parts[2]);
            return { ...t, objDate: objDate };
        })
        .filter(t => t.objDate >= today) 
        .sort((a, b) => a.objDate - b.objDate); 

    if (upcoming.length === 0) {
        list.innerHTML = `<li class="empty-state">No upcoming quests!</li>`;
        return;
    }

    upcoming.forEach(task => {
        const diffTime = task.objDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        
        let timeString = `${diffDays} Days`;
        let timeClass = '';

        if (diffDays === 0) {
            timeString = 'TODAY';
            timeClass = 'today';
        } else if (diffDays === 1) {
            timeString = 'Tomorrow';
            timeClass = 'tomorrow'; 
        }

        const li = document.createElement('li');
        li.className = 'upcoming-item';
        li.innerHTML = `
            <div class="upcoming-header">
                <span class="upcoming-title">${task.title}</span>
                <span class="upcoming-timer ${timeClass}">${timeString}</span>
            </div>
            <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px;">${task.diff.toUpperCase()}</div>
            
            <div class="upcoming-actions">
                 <button class="sidebar-btn finish" onclick="toggleTask('${task.id}')">
                    <i class="fa-solid fa-check"></i> Finish
                 </button>
                 <button class="sidebar-btn remove" onclick="deleteTask('${task.id}')">
                    <i class="fa-solid fa-trash"></i> Remove
                 </button>
            </div>
        `;
        list.appendChild(li);
    });
};

document.getElementById('open-upcoming-sidebar').addEventListener('click', () => {
    renderUpcomingQuests(); 
    upcomingSidebar.classList.add('open');
});
document.getElementById('close-upcoming-sidebar').addEventListener('click', () => upcomingSidebar.classList.remove('open'));


const initSingleTabEnforcement = () => {
    const bc = new BroadcastChannel('midterm_quest_channel');
    const lockOverlay = document.getElementById('tab-lock-overlay');
    
    const TAB_ID = Date.now().toString() + Math.random().toString(36).substr(2, 9);
    
    const otherTabs = new Set();

    const updateLockState = () => {
        if (otherTabs.size > 0) {
            lockOverlay.classList.add('active');
        } else {
            lockOverlay.classList.remove('active');
        }
    };

    bc.onmessage = (event) => {
        const { type, senderId } = event.data;

        if (senderId === TAB_ID) return;

        if (type === 'NEW_TAB') {
            otherTabs.add(senderId);
            updateLockState();
            bc.postMessage({ type: 'I_AM_HERE', senderId: TAB_ID });
        } 
        else if (type === 'I_AM_HERE') {
            otherTabs.add(senderId);
            updateLockState();
        } 
        else if (type === 'LEAVING') {
            otherTabs.delete(senderId);
            updateLockState();
        }
    };

    bc.postMessage({ type: 'NEW_TAB', senderId: TAB_ID });

    window.addEventListener('beforeunload', () => {
         bc.postMessage({ type: 'LEAVING', senderId: TAB_ID });
    });
};


/* === NEW FEATURE: Milestone / Level Path System === */

const msLevels = [1, 5, 10, 15, 20, 25, 30, 40, 50, 60, 75, 90, 100];
// Mock Rewards
const getRewardText = (lvl) => {
    if(lvl === 100) return "Mastery Badge";
    if(lvl % 10 === 0) return "New Theme Color";
    if(lvl % 5 === 0) return "+3 Streak Tokens";
    return "XP Multiplier x1.2";
};

const renderMilestones = () => {
    const track = document.getElementById('milestone-track');
    track.innerHTML = '';
    
    msLevels.forEach(lvl => {
        const isCompleted = appState.level >= lvl;
        
        const card = document.createElement('div');
        card.className = `milestone-card ${isCompleted ? 'completed' : ''}`;
        card.dataset.level = lvl;
        
        const statusText = isCompleted ? 'Unlocked' : 'Locked';
        
        card.innerHTML = `
            <div class="ms-status">${statusText}</div>
            <div class="ms-lvl-badge">
                <i class="fa-solid ${isCompleted ? 'fa-lock-open' : 'fa-lock'}"></i>
            </div>
            <div class="ms-lvl-text">Level ${lvl}</div>
            <div class="ms-reward">${getRewardText(lvl)}</div>
        `;
        
        track.appendChild(card);
    });
};

// Physics for the Bubble Effect
const updateMilestoneVisuals = () => {
    const track = document.getElementById('milestone-track');
    const cards = document.querySelectorAll('.milestone-card');
    const trackCenter = track.getBoundingClientRect().width / 2;

    cards.forEach(card => {
        const cardRect = card.getBoundingClientRect();
        // Calculate center of card relative to the viewport/track
        // We need to account for the track's scroll position in a way, 
        // but getBoundingClientRect gives viewport coords, so we compare card center x to track center x
        
        // Since track is overflow: auto, the rect changes as we scroll.
        const cardCenter = cardRect.left + (cardRect.width / 2);
        const trackLeft = track.getBoundingClientRect().left;
        
        // Distance from the visual center of the modal/track
        const dist = Math.abs((trackLeft + trackCenter) - cardCenter);
        
        // Thresholds
        if (dist < 100) {
            card.classList.add('active');
        } else {
            card.classList.remove('active');
        }
    });
};

const openMilestones = () => {
    const modal = document.getElementById('milestone-modal');
    modal.classList.add('open');
    renderMilestones();
    
    // Auto-scroll to current level
    // Find the closest milestone level <= current level, or just the next one
    let targetLvl = msLevels[0];
    for(let l of msLevels) {
        if(appState.level >= l) targetLvl = l;
        else break; // Show the last achieved one
    }
    
    // Slight delay to allow DOM render
    setTimeout(() => {
        const track = document.getElementById('milestone-track');
        const cards = document.querySelectorAll('.milestone-card');
        const targetCard = Array.from(cards).find(c => parseInt(c.dataset.level) === targetLvl);
        
        if (targetCard) {
            // Scroll calculation to center the target card
            // formula: scrollLeft = card.offsetLeft - (containerWidth/2) + (cardWidth/2)
            const scrollPos = targetCard.offsetLeft - (track.clientWidth / 2) + (targetCard.clientWidth / 2);
            track.scrollTo({ left: scrollPos, behavior: 'smooth' });
        }
        
        // Trigger visual update once
        updateMilestoneVisuals();
    }, 100);
};

// Event Listeners for Milestones
document.getElementById('level-badge').addEventListener('click', openMilestones);
document.getElementById('close-milestones').addEventListener('click', () => {
    document.getElementById('milestone-modal').classList.remove('open');
});

// Attach scroll spy
document.getElementById('milestone-track').addEventListener('scroll', updateMilestoneVisuals);

/* === End Milestone Logic === */


// --- Init ---
const init = async () => {
    changeFocusMode('default');
    
    initSingleTabEnforcement();

    document.getElementById('calendar-switch').setAttribute('data-calendar', appState.calendarType);

    updateStatsUI();
    renderCalendar();
    renderTasks();
    
    if (appState.playlists && appState.playlists.length > 0) {
        const activePl = appState.playlists.find(p => p.id === appState.activePlaylistId) || appState.playlists[0];
        renderSpotifyEmbed(activePl.url);
        renderPlaylistSidebar();
    }

    updateAmbientAudioVolumes(); 
    updateAmbientButtonUI(); 

    await checkStreak(); 
};

init();

    </script>
</body>
</html>
